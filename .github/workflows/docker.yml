name: Publish Docker image
on:
  push:
    tags:
      - v*
jobs:
  build:
    name: build and publish
    runs-on: ubuntu-latest
    steps:
      - name: Define version
        run: |
          echo "PYTHON_VERSION=$(echo '${{ toJSON(github) }}' | jq -r 'select(has("ref")) | .ref[11:] | split("-") | .[0]')" >> $GITHUB_ENV
          echo "POETRY_VERSION=$(echo '${{ toJSON(github) }}' | jq -r 'select(has("ref")) | .ref[11:] | split("-") | .[1]')" >> $GITHUB_ENV

      - uses: actions/checkout@master

      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v1

      - name: Log into GitHub Container Registry
        run: echo "${{ secrets.CR_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Python
        run: |
          docker buildx build \
            --push \
            --platform linux/amd64,linux/arm64 \
            --file Dockerfile.python \
            --build-arg PYTHON_VERSION=${PYTHON_VERSION} \
            -t ghcr.io/unplus/python:${PYTHON_VERSION} .

      - name: Poetry
        run: |
          docker buildx build \
            --push \
            --platform linux/amd64,linux/arm64 \
            --file Dockerfile.poetry \
            --build-arg PYTHON_VERSION=${PYTHON_VERSION} \
            --build-arg POETRY_VERSION=${POETRY_VERSION} \
            -t ghcr.io/unplus/poetry:${POETRY_VERSION}-py${PYTHON_VERSION} .
